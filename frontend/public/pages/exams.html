<div class="container mt-4" style="overflow: scroll;">
  <h2>Manage Exams</h2>

  <div class="mb-3">
    <button class="btn btn-primary" id="btnAddExam" onclick="addExam()">+ Add Exam</button>
    <button class="btn btn-secondary" id="btnToggleLength">Toggle Paginated/All</button>
  </div>

  <!-- DataTable for Exams -->
  <table id="examsTable" class="display nowrap table table-striped" style="width: 100%;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Exam Name</th>
        <th>Semester</th>
        <th>Course Code</th>
        <th>Course</th>
        <th>Session</th>
        <th>Level</th>
        <th>Departments</th>
        <th>Start Time</th>
        <th>Duration</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody><!-- Data loaded by DataTables Ajax --></tbody>
  </table>
</div>
<!-- Modal: Add/Edit Exam -->
<div class="modal fade" id="examModal" tabindex="-1" aria-labelledby="examModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="examForm">
        <div class="modal-header">
          <h5 class="modal-title" id="examModalLabel">Add Exam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="examId" />

          <!-- Basic Exam Fields -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="examName" class="form-label">Exam Name</label>
              <input type="text" class="form-control" id="examName" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="semester" class="form-label">Semester</label>
              <input type="text" class="form-control" id="semester" placeholder="e.g. First Semester" required />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="courseSelect" class="form-label">Course</label>
              <select id="courseSelect" class="form-select" required><!-- from /api/courses --></select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="sessionSelect" class="form-label">Session</label>
              <select id="sessionSelect" class="form-select" required><!-- from /api/sessions --></select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3" style="display: none;">
              <label for="examLevel" class="form-label">Exam Level</label>
              <input type="text" class="form-control" id="examLevel" placeholder="e.g. 200 Level" />
            </div>
            <div class="col-md-12 mb-3">
              <label for="examDepartments" class="form-label">Departments</label>
              <select id="examDepartments" class="form-select" multiple><!-- from /api/departments --></select>
              <small class="text-muted">CTRL/CMD+click for multiple</small>
            </div>
          </div>

          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="max_score_obtainable" class="form-label">Max Score Obtainable</label>
              <input type="number" step="0.01" class="form-control" id="max_score_obtainable" />
            </div>
            <div class="col-md-6 mb-3">
              <label for="examMode" class="form-label">Exam Mode</label>
              <select id="examMode" class="form-select">
                <option value="mock">Mock</option>
                <option value="graded">Graded</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="startTime" class="form-label">Start Time</label>
              <input type="datetime-local" class="form-control" id="startTime" />
            </div>
            <div class="col-md-6 mb-3">
              <label for="duration" class="form-label">Duration (minutes)</label>
              <input type="number" min="1" class="form-control" id="duration" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="unitOfTime" class="form-label">Unit of Time</label>
              <select id="unitOfTime" class="form-select">
                <option value="minutes">Minutes</option>
                <option value="hours">Hours</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="examDate" class="form-label">Exam Date</label>
              <input type="date" class="form-control" id="examDate" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="instruction" class="form-label">Instruction</label>
              <textarea class="form-control" id="instruction"></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label for="venue" class="form-label">Venue</label>
              <input type="text" class="form-control" id="venue" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="examExaminers" class="form-label">Examiner</label>
              <select id="examExaminers" class="form-select" multiple><!-- from /api/exam-examiners --></select>
            </div>
          </div>

          <!-- Additional Toggles -->
          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="server_time" /> Server Time?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="show_max_scores" /> Show Max Scores?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="display_question_randomly" /> Display Random?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="allow_multiple_attempts" /> Allow Multiple Attempts?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="is_public_access" /> Public Access?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="browser_warn_level" /> Browser Warn?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="farewell_message" /> Farewell Message?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="unordered_answering" /> Unordered Answering?
              </label>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="set_pass_mark" /> Set Pass Mark?
              </label>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="form-label">Pass Mark Value</label>
              <input type="number" step="0.01" class="form-control" id="pass_mark_value" />
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label">Pass Mark Unit</label>
              <select id="pass_mark_unit" class="form-select">
                <option value="points">Points</option>
                <option value="percentage">Percentage</option>
              </select>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="grade_with_points" /> Grade with Points?
              </label>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="send_result_mail" /> Send Result Mail?
              </label>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="send_congratulatory_mail" /> Send Congrat Mail?
              </label>
            </div>
          </div>

        </div><!-- /modal-body -->

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success " onclick="saveExam();">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Manage Questions for a Specific Exam -->
<div
  class="modal fade"
  id="examQuestionsModal"
  tabindex="-1"
  aria-labelledby="examQuestionsModalLabel"
  aria-hidden="true"
  style="--bs-modal-width: 90%;"
>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="examQuestionsModalLabel">Exam Questions</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Bulk Upload Button for Questions -->
        <button class="btn btn-info mb-3" onclick="showQuestionUploadModal()">
          Bulk Upload Questions
        </button>
        <!-- Add Single Question Button -->
        <button class="btn btn-primary mb-3" onclick="addExamQuestion()">
          + Add Question
        </button>
        <button class="btn btn-success mb-3" onclick="showQuestionBankModal()">
          From Question Bank
        </button>
        
        <!-- DataTable for exam questions -->
        <table id="examQuestionsTable" class="display table table-striped w-100">
          <thead>
            <tr>
              <th>ID</th>
              <th>Question Text</th>
              <th>Correct Opt</th>
              <th>Score</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Bulk Upload Exam Questions -->
<div
  class="modal fade"
  id="questionUploadModal"
  tabindex="-1"
  aria-labelledby="questionUploadModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <formx id="questionUploadForm" onsubmit="e.preventDefault();" enctype="multipart/form-data" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="questionUploadModalLabel">
            Bulk Upload Exam Questions
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>Select a CSV file containing question data for this exam.</p>
          <input type="hidden" id="uploadExamId" />
          <div class="mb-3">
            <label class="form-label">CSV File</label>
            <input
              class="form-control"
              type="file"
              id="questionCSV"
              accept=".csv"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-info" onclick="bulkUploadExamQuestions();">Upload</button>
        </div>
      </formx>
    </div>
  </div>
</div>

<!-- Modal: Add/Edit Single Question for an Exam -->
<div
  class="modal fade"
  id="examQuestionModal"
  tabindex="-1"
  aria-labelledby="examQuestionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="examQuestionForm">
        <div class="modal-header">
          <h5 class="modal-title" id="examQuestionModalLabel">Add Question</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="questionId" />
          <input type="hidden" id="questionExamId" />
          <input type="hidden" id="questionCourseId" />
          <div class="mb-3">
            <label class="form-label">Correct Option</label>
            <select class="form-select" id="difficulty_level">
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>  
          <div class="mb-3">
            <label class="form-label">Question Type</label>
            <select class="form-select" id="question_type">
              <option value="objective">Objective</option>
              <option value="subjective">Subjective</option>
            </select>
          </div>          
          <!-- Question Text -->
          <div class="mb-3">
            <label class="form-label">Question Text</label>
            <textarea class="form-control" id="questionText" rows="3" required></textarea>
          </div>
          <!-- Options (optional) or correct_option, etc. -->
          <div class="mb-3">
            <label class="form-label">Option A</label>
            <input type="tect" class="form-control" id="option_a" />
          </div>
          <div class="mb-3">
            <label class="form-label">Option B</label>
            <input type="tect" class="form-control" id="option_b" />
          </div>
          <div class="mb-3">
            <label class="form-label">Option C</label>
            <input type="tect" class="form-control" id="option_c" />
          </div>
          <div class="mb-3">
            <label class="form-label">Option D</label>
            <input type="tect" class="form-control" id="option_d" />
          </div>                              
          <div class="mb-3">
            <label class="form-label">Correct Option</label>
            <select class="form-select" id="correctOption">
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Score Obtainable</label>
            <input type="number" class="form-control" id="scoreObtainable" step="0.1" min="0" />
          </div>                   
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-success" onclick="saveExamQuestion();">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Question Bank -->
<div
  class="modal fade"
  id="questionBankModal"
  tabindex="-1"
  aria-labelledby="questionBankModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="questionBankModalLabel">Question Bank</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <table id="questionBankTable" class="display table table-striped w-100">
          <thead>
            <tr>
              <th>Select</th>
              <th>ID</th>
              <th>Text</th>
              <th>Score</th>
              <th>Remove from DB</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <!-- Button to add selected questions to exam -->
        <button class="btn btn-success mt-3" onclick="addSelectedQuestionsToExam()">
          Add Selected to Exam
        </button>
      </div>
    </div>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Bulk upload questions
    document.getElementById("questionUploadForm").addEventListener("submit", (e) => {
      e.preventDefault();
      bulkUploadExamQuestions();
    });
    // Single question form
    document.getElementById("examQuestionForm").addEventListener("submit", (e) => {
      e.preventDefault();
      saveExamQuestion();
    });
  });

  // ====================== EXAM QUESTIONS MGMT ======================
  currentExamId = null;
  currentExamCourseId = null;

  function manageExamQuestions(examId,examName,examCourseId) {
    currentExamId = examId;
    currentExamCourseId = examCourseId;
    initExamQuestionsTable(examId);
    document.getElementById("examQuestionsModalLabel").textContent = "Exam #"+ examId + "-" +examName+" Questions";
    new bootstrap.Modal(document.getElementById("examQuestionsModal")).show();
  }

  function initExamQuestionsTable(examId) {
    if (window.examQuestionsTable) {
      //examQuestionsTable.destroy();
      //delete examQuestionsTable;
      if ($.fn.DataTable.isDataTable("#examQuestionsTable")) {
        $('#examQuestionsTable').DataTable().clear().destroy();
      }
    }
    
    examQuestionsTable = $("#examQuestionsTable").DataTable({
      processing: true,
      ajax: {
        url: API_URL + "exam-questions/" + examId, // e.g. /api/questions/123
        dataSrc: ""
      },
      columns: [
        { data: "question_id" },
        { data: "text" },
        { data: "correct_option" },
        { data: "score_obtainable" },
        {
          data: null,
          render: function (row) {
            return `
              <button class="btn btn-sm btn-primary me-1" onclick="editExamQuestion(${row.question_id}, ${examId})">
                Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteExamQuestion(${row.question_id}, ${examId})">
                Delete
              </button>
            `;
          },
          orderable: false
        }
      ],
      dom: "Bfrtip",
      buttons: [
        "pageLength",
        { extend: "csvHtml5", title: "ExamQuestions_Export" },
        { extend: "excelHtml5", title: "ExamQuestions_Export" },
        { extend: "print", title: "Exam Questions List" }
      ],
      responsive: true
    });
  }

  function showQuestionUploadModal() {
    document.getElementById("uploadExamId").value = currentExamId;
    document.getElementById("questionCSV").value = "";
    new bootstrap.Modal(document.getElementById("questionUploadModal")).show();
  }

  function bulkUploadExamQuestions() {
    const examId = document.getElementById("uploadExamId").value;
    const fileInput = document.getElementById("questionCSV");
    if (!fileInput.files[0]) {
      alert("Please select a CSV file for exam questions.");
      return;
    }
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("exam_id", currentExamId);
    formData.append("course_id", currentExamCourseId);
    

    fetch(API_URL + `exam-questions/${examId}/bulk-upload`, {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        bootstrap.Modal.getInstance(document.getElementById("questionUploadModal")).hide();
        alert(data.message || "Bulk exam questions upload completed.");
        examQuestionsTable.ajax.reload(null, false);
      })
      .catch(() => alert("Failed to import exam questions."));
  }

  function addExamQuestion() {
    document.getElementById("questionId").value = "";
    document.getElementById("questionExamId").value = currentExamId;
    document.getElementById("questionCourseId").value = currentExamCourseId;
    document.getElementById("examQuestionModalLabel").textContent = "Add Question";
    document.getElementById("difficulty_level").value = "easy";
    document.getElementById("question_type").value = "objective"; 
    document.getElementById("questionText").value = "";
    document.getElementById("option_a").value = "";
    document.getElementById("option_b").value = "";
    document.getElementById("option_c").value = "";
    document.getElementById("option_d").value = "";    
    document.getElementById("correctOption").value = "A";
    document.getElementById("scoreObtainable").value = "0";   
    new bootstrap.Modal(document.getElementById("examQuestionModal")).show();
  }

  function editExamQuestion(questionId, examId) {
    fetch(API_URL + `questions/${questionId}`)
      .then(res => res.json())
      .then(q => {
        document.getElementById("questionId").value = q.id;
        document.getElementById("questionCourseId").value = q.course_id;
        document.getElementById("questionExamId").value = examId;
        document.getElementById("difficulty_level").value = q.difficulty_level || "easy";
        document.getElementById("question_type").value = q.question_type || "objective";
        document.getElementById("questionText").value = q.text || "";
        document.getElementById("option_a").value = q.option_a || "";
        document.getElementById("option_b").value = q.option_b || "";
        document.getElementById("option_c").value = q.option_c || "";
        document.getElementById("option_d").value = q.option_d || "";
        document.getElementById("correctOption").value = q.correct_option || "A";
        document.getElementById("scoreObtainable").value = q.score_obtainable || 0;
        document.getElementById("examQuestionModalLabel").textContent = "Edit Question";
        new bootstrap.Modal(document.getElementById("examQuestionModal")).show();
      })
      .catch(() => alert("Failed to fetch question data."));
  }

  function saveExamQuestion() {
    const id = document.getElementById("questionId").value;
    const examId = document.getElementById("questionExamId").value;

    const payload = {
      course_id: document.getElementById("questionCourseId").value.trim(),
      difficulty_level: document.getElementById("difficulty_level").value.trim(),
      question_type: document.getElementById("question_type").value.trim(),
      text: document.getElementById("questionText").value.trim(),
      option_a: document.getElementById("option_a").value.trim(),
      option_b: document.getElementById("option_b").value.trim(),
      option_c: document.getElementById("option_c").value.trim(),
      option_d: document.getElementById("option_d").value.trim(),
      correct_option: document.getElementById("correctOption").value,
      score_obtainable: document.getElementById("scoreObtainable").value
    };

    if (id) {
      // Update existing question
      payload.id = id;
      fetch(API_URL + `questions/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(() => {
          bootstrap.Modal.getInstance(document.getElementById("examQuestionModal")).hide();
          alert("Question updated.");
          examQuestionsTable.ajax.reload(null, false);
        })
        .catch(() => alert("Failed to update question."));
    } else {
      // Create new question
      payload.exam_id = examId; // link to the exam
      fetch(API_URL + "exam-questions/addNew", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(() => {
          bootstrap.Modal.getInstance(document.getElementById("examQuestionModal")).hide();
          alert("Question added.");
          examQuestionsTable.ajax.reload(null, false);
        })
        .catch(() => alert("Failed to add question."));
    }
  }

  function deleteExamQuestion(questionId, examId) {
    if (!confirm("Are you sure you want to remove this question?")) return;
    fetch(API_URL + `exam-questions/` + currentExamId + `/` + `${questionId}`, {
      method: "DELETE"
    })
      .then(res => res.json())
      .then(() => {
        alert("Question deleted.");
        examQuestionsTable.ajax.reload(null, false);
      })
      .catch(() => alert("Failed to delete question."));
  }

</script>
<script>
  showingAll = false;
  examsTable;

  document.addEventListener("DOMContentLoaded", function () {
    initExamsDataTable();

    document.getElementById("btnAddExam").addEventListener("click", addExam);
    document.getElementById("btnToggleLength").addEventListener("click", function () {
      showingAll = !showingAll;
      examsTable.page.len(showingAll ? -1 : 10).draw(false);
    });

    // Save exam form
    document.getElementById("examForm").addEventListener("submit", function (e) {
      e.preventDefault();
      saveExam();
    });
  });
function showAllExams(){
  showingAll = !showingAll;
      examsTable.page.len(showingAll ? -1 : 10).draw(false);
}


  function initExamsDataTable() {
    examsTable = $("#examsTable").DataTable({
      processing: true,
      ajax: {
        url: API_URL + "exams",
        dataSrc: ""
      },
      columns: [
        { data: "id" },
        { data: "exam_name" },
        { data: "semester" },
        { data: "course_code" },
        { data: "course_name" },
        { data: "session_name" },
        { data: "course_level" },
        {data: "departments",},
        { data: "start_time" },
        { data: "duration" },
        {
          data: null,
          render: function (row) {
            return `
              <button class="btn btn-sm btn-primary me-1" onclick="editExam(${row.id})">Edit</button>
              <button class="btn btn-sm btn-danger me-1" onclick="deleteExam(${row.id})">Delete</button>
              <button class="btn btn-sm btn-info" onclick="manageExamQuestions(${row.id},'${row.exam_name}',${row.course_id})">Manage Questions</button>
            `;
          },
          orderable: false
        }
      ],
      dom: "Bfrtip",
      buttons: ["pageLength", "csvHtml5", "excelHtml5", "print"],
      responsive: true,
      pageLength: 10,
      lengthMenu: [[10,25,50,-1],[10,25,50,"All"]]
    });
  }

  function addExam() {
    clearExamForm();
    document.getElementById("examModalLabel").textContent = "Add Exam";
    loadDropdowns(); // to fill courseSelect, sessionSelect, etc.
    new bootstrap.Modal(document.getElementById("examModal")).show();
  }

  function editExam(examId) {
    fetch(API_URL + "exams/" + examId)
      .then(res => res.json())
      .then(exam => {
        document.getElementById("examId").value = exam.id || "";
        document.getElementById("examName").value = exam.exam_name || "";
        document.getElementById("semester").value = exam.semester || "";
        document.getElementById("examLevel").value = exam.level || "";
        document.getElementById("max_score_obtainable").value = exam.max_score_obtainable || "";
        document.getElementById("examMode").value = exam.exam_mode || "mock";
        $("#startTime").val(exam.exam_date + "T" + exam.start_time);
        document.getElementById("duration").value = exam.duration || "";
        document.getElementById("unitOfTime").value = exam.unit_of_time || "minutes";
        document.getElementById("examDate").value = exam.exam_date || "";
        document.getElementById("instruction").value = exam.instruction || "";
        document.getElementById("venue").value = exam.venue || "";

        // Checkboxes
        document.getElementById("server_time").checked = !!exam.server_time;
        document.getElementById("show_max_scores").checked = !!exam.show_max_scores;
        document.getElementById("display_question_randomly").checked = !!exam.display_question_randomly;
        document.getElementById("allow_multiple_attempts").checked = !!exam.allow_multiple_attempts;
        document.getElementById("is_public_access").checked = !!exam.is_public_access;
        document.getElementById("browser_warn_level").checked = !!exam.browser_warn_level;
        document.getElementById("farewell_message").checked = !!exam.farewell_message;
        document.getElementById("unordered_answering").checked = !!exam.unordered_answering;
        document.getElementById("set_pass_mark").checked = !!exam.set_pass_mark;
        document.getElementById("pass_mark_value").value = exam.pass_mark_value || "";
        document.getElementById("pass_mark_unit").value = exam.pass_mark_unit || "points";
        document.getElementById("grade_with_points").checked = !!exam.grade_with_points;
        document.getElementById("send_result_mail").checked = !!exam.send_result_mail;
        document.getElementById("send_congratulatory_mail").checked = !!exam.send_congratulatory_mail;

        loadDropdowns(exam.course_id, exam.session_id, exam.departments);

        document.getElementById("examModalLabel").textContent = "Edit Exam";
        new bootstrap.Modal(document.getElementById("examModal")).show();
      })
      .catch(() => alert("Failed to fetch exam."));

                // Load Departments and mark those linked to this exam
    fetch(API_URL + `exam-departments/${examId}/departments`)
      .then(res => res.json())
      .then(departments => {
        const deptSelect = document.getElementById("examDepartments");
        deptSelect.innerHTML = "";
        fetch(API_URL + "departments")
          .then(res => res.json())
          .then(allDepartments => {
            allDepartments.forEach(d => {
              let opt = document.createElement("option");
              opt.value = d.id;
              opt.textContent = d.name;
              if (departments.some(examDept => examDept.department_id === d.id)) {
                opt.selected = true;
              }
              deptSelect.appendChild(opt);
            });
          })
          .catch(() => alert("Failed to load departments."));
      })
      .catch(() => alert("Failed to fetch exam departments."));

          // Load Examiners
    fetch(API_URL + `exam-examiners/exam/${examId}`)
      .then(res => res.json())
      .then(examiners => {
        const examinerSelect = document.getElementById("examExaminers");
        examinerSelect.innerHTML = "";
        fetch(API_URL + "staff")
          .then(res => res.json())
          .then(allStaff => {
            allStaff.forEach(e => {
              let opt = document.createElement("option");
              opt.value = e.id;
              opt.textContent = e.first_name + " " + e.last_name;
              if (examiners.some(examEx => examEx.staff_id === e.id)) {
                opt.selected = true;
              }
              examinerSelect.appendChild(opt);
            });
          })
          .catch(() => alert("Failed to load staff."));
      })
      .catch(() => alert("Failed to fetch exam examiners."));
      
  }

  function clearExamForm() {
    document.getElementById("examId").value = "";
    document.getElementById("examName").value = "";
    document.getElementById("semester").value = "";
    document.getElementById("examLevel").value = "";
    document.getElementById("max_score_obtainable").value = "";
    document.getElementById("examMode").value = "mock";
    document.getElementById("startTime").value = "";
    document.getElementById("duration").value = "";
    document.getElementById("unitOfTime").value = "minutes";
    document.getElementById("examDate").value = "";
    document.getElementById("instruction").value = "";
    document.getElementById("venue").value = "";

    document.getElementById("server_time").checked = false;
    document.getElementById("show_max_scores").checked = false;
    document.getElementById("display_question_randomly").checked = false;
    document.getElementById("allow_multiple_attempts").checked = false;
    document.getElementById("is_public_access").checked = false;
    document.getElementById("browser_warn_level").checked = false;
    document.getElementById("farewell_message").checked = false;
    document.getElementById("unordered_answering").checked = false;
    document.getElementById("set_pass_mark").checked = false;
    document.getElementById("pass_mark_value").value = "";
    document.getElementById("pass_mark_unit").value = "points";
    document.getElementById("grade_with_points").checked = false;
    document.getElementById("send_result_mail").checked = false;
    document.getElementById("send_congratulatory_mail").checked = false;
    
    // Clears the select boxes
    document.getElementById("courseSelect").innerHTML = "";
    document.getElementById("sessionSelect").innerHTML = "";
    document.getElementById("examDepartments").innerHTML = "";
  }

  function loadDropdowns(selectedCourseId=null, selectedSessionId=null, selectedDepts=[]) {
    // Course
    fetch(API_URL + "courses")
      .then(res => res.json())
      .then(courses => {
        const courseSel = document.getElementById("courseSelect");
        courseSel.innerHTML = "";
        courses.forEach(c => {
          let opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent =  c.code + "-" + c.name;
          if (selectedCourseId && c.id === selectedCourseId) opt.selected = true;
          courseSel.appendChild(opt);
        });
      })
      .catch(() => alert("Failed to load courses."));

    // Session
    fetch(API_URL + "sessions")
      .then(res => res.json())
      .then(sessions => {
        const sessionSel = document.getElementById("sessionSelect");
        sessionSel.innerHTML = "";
        sessions.forEach(s => {
          let opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.name; // e.g. "2024/2025"
          if (selectedSessionId && s.id === selectedSessionId) opt.selected = true;
          sessionSel.appendChild(opt);
        });
      })
      .catch(() => alert("Failed to load sessions."));

    // Departments multi-select
    fetch(API_URL + "departments")
      .then(res => res.json())
      .then(depts => {
        const deptSel = document.getElementById("examDepartments");
        deptSel.innerHTML = "";
        depts.forEach(d => {
          let opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name;
          // if editing, pre-select matched depts
          if (selectedDepts.some(sd => sd.id === d.id)) {
            opt.selected = true;
          }
          deptSel.appendChild(opt);
        });
      })
      .catch(() => alert("Failed to load departments."));
  }

  function saveExam() {
    const id = document.getElementById("examId").value;
    // Checkboxes => 0/1
    function boolTo01(cbId) {
      return document.getElementById(cbId).checked ? 1 : 0;
    }

    const payload = {
      exam_name: document.getElementById("examName").value.trim(),
      semester: document.getElementById("semester").value.trim(),
      course_id: +document.getElementById("courseSelect").value,
      session_id: +document.getElementById("sessionSelect").value,
      level: document.getElementById("examLevel").value.trim(),
      max_score_obtainable: document.getElementById("max_score_obtainable").value.trim(),
      exam_mode: document.getElementById("examMode").value, // "mock" or "graded"
      start_time: document.getElementById("startTime").value.replace("T", " "),
      duration: +document.getElementById("duration").value,
      unit_of_time: document.getElementById("unitOfTime").value, // "minutes" or "hours"
      exam_date: document.getElementById("examDate").value, // e.g. "2025-03-10"
      instruction: document.getElementById("instruction").value.trim(),
      venue: document.getElementById("venue").value.trim(),
      
      server_time: boolTo01("server_time"),
      show_max_scores: boolTo01("show_max_scores"),
      display_question_randomly: boolTo01("display_question_randomly"),
      allow_multiple_attempts: boolTo01("allow_multiple_attempts"),
      is_public_access: boolTo01("is_public_access"),
      browser_warn_level: boolTo01("browser_warn_level"),
      farewell_message: boolTo01("farewell_message"),
      unordered_answering: boolTo01("unordered_answering"),
      set_pass_mark: boolTo01("set_pass_mark"),
      pass_mark_value: document.getElementById("pass_mark_value").value.trim(),
      pass_mark_unit: document.getElementById("pass_mark_unit").value, // "points" or "percentage"
      grade_with_points: boolTo01("grade_with_points"),
      send_result_mail: boolTo01("send_result_mail"),
      send_congratulatory_mail: boolTo01("send_congratulatory_mail")
    };

    // multi-select departments
    const deptSel = document.getElementById("examDepartments");
    const selectedDeptIds = Array.from(deptSel.selectedOptions).map(opt => +opt.value);
    payload.department_ids = selectedDeptIds;
    assignDepartmentsToExam(id);
 
    // multi-select departments
    const examinerSel = document.getElementById("examExaminers");
    const selectedExaminerIds = Array.from(examinerSel.selectedOptions).map(opt => +opt.value);
    payload.examiners_ids = selectedExaminerIds;
    assignExaminersToExam(id);   
    
    //DELETE EXAMINERS AND ADD THE NEW ONES ON CLIENT

    const method = id ? "PUT" : "POST";
    const url = id ? `${API_URL}exams/${id}` : `${API_URL}exams`;

    fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(res => res.json())
      .then(() => {
        bootstrap.Modal.getInstance(document.getElementById("examModal")).hide();
        alert("Exam saved successfully.");
        examsTable.ajax.reload(null, false);
      })
      .catch(() => alert("Failed to save exam."));
  }

  function deleteExam(examId) {
    if (!confirm("Are you sure you want to delete this exam?")) return;
    fetch(`${API_URL}exams/${examId}`, { method: "DELETE" })
      .then(res => res.json())
      .then(() => {
        alert("Exam deleted.");
        examsTable.ajax.reload(null, false);
      })
      .catch(() => alert("Failed to delete exam."));
  }


  function assignDepartmentsToExam(examId) {
    const deptSel = document.getElementById("examDepartments");
    const selectedDeptIds = Array.from(deptSel.selectedOptions).map(opt => +opt.value);

    return fetch(`${API_URL}exam-departments/${examId}/remove-all`, { 
        method: "DELETE" 
    }).then(() => {
        // Delay before assigning new departments
        setTimeout(() => {
            fetch(`${API_URL}exam-departments/${examId}/assign-multiple`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ department_ids: selectedDeptIds })
            });
        }, 1000);
    }).catch(error => console.error("Error:", error));
}
  // The rest of the code for "Manage Exam Questions" remains the same
  // (initExamQuestionsTable, addExamQuestion, editExamQuestion, saveExamQuestion, etc.)

  function assignExaminersToExam(examId) {
    const examinerSel = document.getElementById("examExaminers");
    const selectedExaminerIds = Array.from(examinerSel.selectedOptions).map(opt => +opt.value);

    // First, remove all examiners
    return fetch(`${API_URL}exam-examiners/remove-all/${examId}`, { method: "DELETE" })
        .then(() => {
            // Introduce a delay before assigning examiners
            return new Promise(resolve => setTimeout(resolve, 1000));
        })
        .then(() => {
            // Assign examiners after the delay
            return fetch(`${API_URL}exam-examiners/${examId}/assign-multiple`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ exam_id: examId, examiners_ids: selectedExaminerIds })
            });""
        })
        .catch(error => console.error("Error:", error));
}


</script>
<script>
questionBankTable;

// 1) Called when user clicks "From Question Bank"
function showQuestionBankModal() {
  if (!currentExamCourseId) {
    alert("Exam course_id is unknown. Please open an exam first.");
    return;
  }

  // Destroy existing DataTable if it exists
  if ($.fn.DataTable.isDataTable("#questionBankTable")) {
    $("#questionBankTable").DataTable().clear().destroy();
  }

  // Initialize DataTable after clearing
  initQuestionBankTable();

  // Show the modal
  new bootstrap.Modal(document.getElementById("questionBankModal")).show();
}

// 2) Initialize the DataTable with Ajax to your question bank
function initQuestionBankTable() {
  questionBankTable = $("#questionBankTable").DataTable({
    processing: true,
    ajax: {
      url: API_URL + "questions?course_id=" + currentExamCourseId,
      dataSrc: ""
    },
    columns: [
      {
        // 1) Checkbox
        data: null,
        render: function (row) {
          return `<input type="checkbox" class="qbankSelect" value="${row.id}" />`;
        },
        orderable: false,
        searchable: false
      },
      { data: "id" },
      { data: "text" },
      {
        data: "score_obtainable",
        render: function (score) {
          return score || "0";
        }
      },
      {
        // 2) Remove from DB button
        data: null,
        render: function (row) {
          return `
            <button class="btn btn-danger btn-sm" onclick="moveQuestionFromDatabase(${row.id})">
              Remove from DB
            </button>
          `;
        },
        orderable: false,
        searchable: false
      }
    ],
    responsive: true,
    pageLength: 10
  });
}

function moveQuestionFromDatabase(questionId) {
  if (!confirm("Are you sure you want to remove this question from the entire DB?")) {
    return;
  }

  fetch(API_URL + `questions/move-from-db/${questionId}`, { method: "DELETE" })
    .then(res => res.json())
    .then(data => {
      alert(data.message || "Question removed from DB.");
      // Reload the question bank table
      questionBankTable.ajax.reload(null, false);
      // Also reload examQuestions table if that question was assigned
      examQuestionsTable.ajax.reload(null, false);
    })
    .catch(err => {
      console.error("Remove question from DB error:", err);
      alert("Failed to remove question from DB.");
    });
}



function addSelectedQuestionsToExam() {
  const cbs = document.querySelectorAll(".qbankSelect:checked");
  if (!cbs.length) {
    alert("No questions selected from bank.");
    return;
  }

  let successCount = 0;
  let failCount = 0;

  const promises = Array.from(cbs).map(cb => {
    const questionId = cb.value;
    return fetch(API_URL + "exam-questions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        exam_id: currentExamId, // from your manageExamQuestions approach
        question_id: questionId
      })
    })
      .then(r => {
        if (r.ok) successCount++;
        else failCount++;
      })
      .catch(() => failCount++);
  });

  Promise.all(promises).then(() => {
    alert(`Added ${successCount} questions to exam. ${failCount} failed.`);
    // Reload examQuestions
    examQuestionsTable.ajax.reload(null, false);
    // Clear checkboxes
    cbs.forEach(cb => (cb.checked = false));
  });
}

</script>
<script>
  // Re-init after dynamic load if needed
  setTimeout(initExamsDataTable, 100);
</script>
<!-- Example CKEditor 4 CDN link. If using CKEditor 5, see their official docs -->
<script src="/js/ckeditor/ckeditor.js"></script>
<script src="/js/ckeditor/tex-chtml.js"></script>
<script>
  function activateCKeditor() {
    // Replace textareas/inputs with CKEditor
    CKEDITOR.replace("questionText", {
      extraPlugins: "mathjax",
      mathJaxLib: "/js/ckeditor/tex-chtml.js",
      // Optionally, how you want to wrap the equations:
      mathJaxClass: "cke_mathjax",
      mathJaxStyle: {
        "font-size": "110%"
      }
    });
    CKEDITOR.replace('option_a');     // for <textarea> or <input type="text">
    CKEDITOR.replace('option_b');
    CKEDITOR.replace('option_c');
    CKEDITOR.replace('option_d');
  };
//activateCKeditor();
</script>